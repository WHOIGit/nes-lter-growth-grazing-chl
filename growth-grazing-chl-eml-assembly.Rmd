---
title: "nes-lter-nutrients-transect-emlassemblyline"
author: "Kate Morkeski, Jaxine Wolfe"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(message = FALSE, warning = FALSE)

# install and load libraries
#library(devtools)
#install_github('WHOIGit/ediutilities')
#install_github("EDIorg/EMLassemblyline")

library(EMLassemblyline)
library(ediutilities)
library(here)
#library(tidyverse)
library(EML)
library(xml2)

```

## Read in Data Table

```{r}

grazing_data <- read.csv("nes-lter-growth-grazing-chl.csv")

```
## QA: Map Sampling Locations

Call the map_locs function from ediutilities to map the sampling locations. Perform a visual check.

```{r, echo=FALSE}

# Map Check
map_locs(df = grazing_data, xvar = "longitude", yvar = "latitude",
         region = "transect", colorvar = "cruise")

```

## EML Assembly

This chunk outputs the final xml file for EDI through the following steps:

Step 1: Populating EML Assembly Line templates with metadata
Step 2: Calculating the geospatial and temporal coverage 
Step 3: Making the XML file 
Step 4: Inserting a custom NES-LTER parent project node 

```{r}

# define input files
edi_filename <- "nes-lter-growth-grazing-chl"
metadata <- "nes-lter-growth-grazing-chl-info"
pkg_id <- "knb-lter-nes.5.2"

# Make EML Templates 
# Specify methods file type as markdown
excel_to_template(here(metadata), edi_filename, rights='CCBY', file_type=".md")

# Data Coverage
# isolate date and geospatial columns for input
date_col <- as.Date(grazing_data$date_time_utc_sampling)
#date_col <- grazing_data$date_time_utc_sampling
lat_col <- grazing_data$latitude
lon_col <- grazing_data$longitude
# run function to determine geospatial and temporal coverage
coverage <- data_coverage(dates = date_col, lat = lat_col, lon = lon_col)

# Make EML
make_eml(here(),
         dataset.title = "Phytoplankton growth and microzooplankton grazing rates from NES-LTER transect cruises, ongoing since 2017.",
         data.table = paste0(edi_filename, ".csv"),
         data.table.description = "Phytoplankton growth and microzooplankton grazing rates with size-fractionated chlorophyll concentration",
         other.entity = c("chl-grazing-experiment-temp-inc-data.zip"),
         other.entity.description = c("Temperature and light intensity recorded during the incubation experiments"),
         temporal.coverage = c(coverage$startdate, coverage$enddate),
         geographic.description = "NES-LTER Transect",
         geographic.coordinates = c(coverage$North, coverage$East, coverage$South, coverage$West),
         maintenance.description = "ongoing",
         user.id = "NES",
         user.domain = "LTER",
         package.id = pkg_id)

project_insert(pkg_id, filename='parent_project_RAPID.txt')

```


