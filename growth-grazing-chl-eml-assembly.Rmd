---
title: "nes-lter-nutrients-transect-emlassemblyline"
author: "Jaxine Wolfe"
date: "Oct 20, 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(message = FALSE, warning = FALSE)

# clear workspace for local development
rm(list = ls())

# assign resused directory to a variable
dir <- "/Users/jaxinewolfe/Documents/WHOI/NESLTER/nes-lter-growth-grazing-chl/"
# set working directory
setwd(dir)

# define source for functions developed for the EDI packaging workflow
source("edi-utilities.R")

# install and load libraries
# install.packages("devtools")
# install_github("EDIorg/EMLassemblyline")

# define R packages to require
libs <- c("tidyverse", "readxl", "lubridate", "devtools", "EMLassemblyline", "EML", "maps", "xml2")
# load libraries
lapply(libs, require, character.only = TRUE)

```

## Preparing Provided Data for EDI

• if theres a "-" in the cast or a "/" in the bottle, insert a "|".
• the missing values in numeric fields should be numeric
```{r}
# set filename to variable
pierre_data <- "NES-LTER_Growth-Grazing_SMD_2019_11_01"
edi_filename <- "nes-lter-growth-grazing-chl"

# Load growth and grazing data from excel sheet
growgraze <- read_excel(path = paste0(dir, "/", pierre_data, ".xlsx"), 
                  sheet = "DataTable", na = "NA")

# DATA CLEANING
# standardize the formatting of the cast and bottle columns
growgraze$cast <- trimws(gsub('-', '|', growgraze$cast))
growgraze$bottle <- trimws(gsub('/', '|', growgraze$bottle))

# Add categorical columns to expand missing value explantions
# define columms containing missing values
mv_cols <- c("mu_N", "mu_N_Std", "grazing", "grazing_Std", "mu_10d", 
             "mu_10d_Std", "grazing_10d", "grazing_10d_Std", "mu_10u", 
             "mu_10u_Std", "grazing_10u", "grazing_10u_Std")

mv <- growgraze %>% select(mv_cols) %>%
  # rename to incidate that these are the missing value columns
  rename_at(mv_cols, ~ paste0(mv_cols, "_mv"))

# convert numerical values in missing value explanation columns to not missing 
mv[mv != "n/n" & mv != "n/a" & 
               mv != "n/d" & mv != "n/c"] <- "not missing"

# convert missing values in original columns to -9999
growgraze[growgraze == "n/n" | growgraze == "n/a" |
            growgraze == "n/d" | growgraze == "n/c"] <- -9999
# assign columns to numerical
growgraze[mv_cols] <- sapply(growgraze[mv_cols], as.numeric)
# str(growgraze) # check

# add the missing value explanation columns to the data
growgraze_EDI <- cbind(growgraze, mv)

# rearrange columns to match the order in the attributes table
growgraze_EDI <- growgraze_EDI[,c("project", "cruise", "date_time_UTC", "station", "cast", "bottle", "latitude", "longitude", "depth", "temp", "sal", "date_time_start_UTC", "date_time_end_UTC", "light_treatment", "mu_0", "mu_0_Std",
                                  "mu_N", "mu_N_mv", "mu_N_Std", "mu_N_Std_mv", "grazing", "grazing_mv", "grazing_Std", "grazing_Std_mv", "mu_10d",
                                  "mu_10d_mv",  "mu_10d_Std", "mu_10d_Std_mv" , "grazing_10d", "grazing_10d_mv", "grazing_10d_Std", "grazing_10d_Std_mv",
                                  "mu_10u", "mu_10u_mv", "mu_10u_Std", "mu_10u_Std_mv", "grazing_10u", "grazing_10u_mv", "grazing_10u_Std", 
                                  "grazing_10u_Std_mv", "temp_light_inc_filename")]

write.csv(growgraze_EDI, paste0(edi_filename, ".csv"), row.names = FALSE)
```

## Quality Assurance: Nutrients Check

This chunk checks the nutrient values used by Pierre against the nutrient values from teh NES-LTER nutrients transect. The second version that Pierre provided produced no mismatched averages.
```{r}

# load in nutrients data (provided by Pierre)
nutrients_xls <- "NES-LTER_Nutrients_SMD_2019_11_01.xlsx"
# Load in nutrient data from excel sheet
nut_pierre <- read_excel(path = paste0(dir, "/", nutrients_xls), 
                  sheet = 1, na = "NA")

# load in nes-lter nutrient transect data 
# these will be compared against the NES-LTER nutrient-transect data
nut_transect <- read_csv("https://raw.githubusercontent.com/WHOIGit/nes-lter-nutrient-transect/master/nes-lter-nutrient-transect.csv")

nut_transect_avg <- nut_transect %>%
  group_by(cruise, cast, niskin, depth) %>%
  # calculate the average nutrients across the replicate samples
  summarize(avg_nitrate_nitrite = mean(nitrate_nitrite),
            avg_phosphate = mean(phosphate),
            avg_silicate = mean(silicate),
            avg_ammonium = mean(ammonium)) %>%
  # isolate the surface samples for each cruise-cast combo
  group_by(cruise, cast) %>%
  slice(which.min(depth))

# merge datasets for comparison 
nut_check <- left_join(nut_pierre, nut_transect_avg,
                       by = c("cruise", "castNut"="cast", "depthNut"="depth"))
# rename nitrate nitrite col
colnames(nut_check)[colnames(nut_check)=="Nitrate+Nitrite"] <- "Nitrate_Nitrite"

# create empty columns to check mismatches
nut_check$nitrate_nitrite_match <- FALSE
nut_check$phosphate_match <- FALSE
nut_check$ammonium_match <- FALSE
nut_check$silicate_match <- FALSE

for (i in 1:nrow(nut_check)) {
    # if the average values match for each nutrient, set name to true
    if (round(nut_check$Nitrate_Nitrite[i], 2) == round(nut_check$avg_nitrate_nitrite[i], 2)) {
    nut_check$nitrate_nitrite_match[i] <- TRUE
    }
    if (round(nut_check$Phosphate[i], 2) == round(nut_check$avg_phosphate[i], 2)) {
    nut_check$phosphate_match[i] <- TRUE
    }
    if (round(nut_check$Ammonium[i], 2) == round(nut_check$avg_ammonium[i], 2)) {
    nut_check$ammonium_match[i] <- TRUE
    }
    if (round(nut_check$Silicate[i], 2) == round(nut_check$avg_silicate[i], 2)) {
    nut_check$silicate_match[i] <- TRUE
    }
  }

# isolate mismatches
mismatch <- nut_check[nut_check$silicate_match==FALSE,]

```

## Quality Assurance: Consistency Check

This chunk determines if there are differences across the two light treatments.
```{r}

gg_check_EN608 <- growgraze_EDI %>%
  select(project:sal) %>%
  filter(cruise == "EN608")
unique(gg_check_EN608)

gg_check_EN617 <- growgraze_EDI %>%
  select(project:sal) %>%
  filter(cruise == "EN617")
unique(gg_check_EN617)

gg_check_EN627 <- growgraze_EDI %>%
  select(project:sal) %>%  
  filter(cruise == "EN627")
unique(gg_check_EN627)

```


## Quality Assurance: Map Sampling Locations

```{r, echo=FALSE}

# Map Check
map_locs(growgraze_EDI, longitude, latitude, region = "transect")

```

## EML Assembly

This chunk outputs the final xml file for EDI through the following steps:

Step 1: Populating EML Assembly Line templates with metadata
Step 2: Calculating the geospatial and temporal coverage 
Step 3: Making the XML file 
Step 4: Inserting a custom NES-LTER parent project node 

```{r}

# define input files
metadata <- "NES-LTER_Growth-Grazing_SMD_2019_11_01"
edi_filename <- "nes-lter-growth-grazing-chl"
pkg_id <- "knb-lter-nes.5.1"

# Make EML Templates 
xlsx_to_template(metadata.path = metadata, 
                 edi.filename = edi_filename, 
                 rights = "CCBY")

# Data Coverage
# isolate date and geospatial columns for input
date_col <- as.Date(growgraze_EDI$date_time_UTC)
lat_col <- growgraze_EDI$latitude
lon_col <- growgraze_EDI$longitude
# run function to determine geospatial and temporal coverage
coverage <- data_coverage(dates = date_col, lat = lat_col, lon = lon_col)

# Make EML
make_eml(path = getwd(),
         dataset.title = "Phytoplankton growth and microzooplankton grazing rates from NES-LTER transect cruises EN608, EN617, EN627.",
         data.table = paste0(edi_filename, ".csv"),
         data.table.description = "Phytoplankton growth and microzooplankton grazing rates data cleaned for EDI",
         other.entity = c(paste0(metadata, ".xlsx"), "NES-LTER_temp_light_incubation_SMD.zip"),
         other.entity.description = c("Phytoplankton growth and microzooplankton grazing rates contributed by the Menden-Deuer lab",
                                      "Temperature and light intensity recorded during the incubation experiments"),
         temporal.coverage = c(coverage$startdate, coverage$enddate),
         geographic.description = "NES-LTER Transect",
         geographic.coordinates = c(coverage$North, coverage$East, coverage$South, coverage$West),
         maintenance.description = "ongoing",
         user.id = "NES",
         affiliation = "LTER",
         package.id = pkg_id)

# Insert Custom Project Node
project_insert(edi_pkg = pkg_id)
```
