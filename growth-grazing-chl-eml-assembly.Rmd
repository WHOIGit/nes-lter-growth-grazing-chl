---
title: "nes-lter-nutrients-transect-emlassemblyline"
author: "Kate Morkeski, Jaxine Wolfe"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(message = FALSE, warning = FALSE)

# install and load libraries
#library(devtools)
#install_github('WHOIGit/ediutilities')
#install_github("EDIorg/EMLassemblyline")

library(EMLassemblyline)
library(ediutilities)
library(here)
library(lubridate)
library(tidyverse)
require(readxl)
require(lubridate)
require(devtools)
require(EML)
require(maps)
require(xml2)

```

## Preparing Provided Data for EDI

```{r}

edi_filename <- "nes-lter-growth-grazing-chl"

# set filename to variable
grazing_data <- read_csv("NES-LTER-chla-grazing-experiments-rates-qc-noquote.csv")

#write_csv(grazing_data, paste0(edi_filename, ".csv"))
# this inserts T and Z into datetime format

write.csv(grazing_data, paste0(edi_filename, ".csv"), row.names = FALSE)

grazing_data <- read_csv("nes-lter-growth-grazing-chl.csv")


```
## QA: Map Sampling Locations

Call the map_locs function from ediutilities to map the sampling locations. Perform a visual check.

```{r, echo=FALSE}

# Map Check
map_locs(df = grazing_data, xvar = "longitude", yvar = "latitude",
         region = "transect", colorvar = "cruise")

```

## EML Assembly

This chunk outputs the final xml file for EDI through the following steps:

Step 1: Populating EML Assembly Line templates with metadata
Step 2: Calculating the geospatial and temporal coverage 
Step 3: Making the XML file 
Step 4: Inserting a custom NES-LTER parent project node 

```{r}

# define input files
metadata <- "nes-lter-growth-grazing-chl-info"
pkg_id <- "knb-lter-nes.5.2"

# Make EML Templates 
# Specify methods file type as markdown
excel_to_template(here(metadata), edi_filename, rights='CCBY', file_type=".md")

# Data Coverage
# isolate date and geospatial columns for input
#date_col <- as.Date(grazing_data$date_time_UTC)
date_col <- grazing_data$date_time_utc_sampling
lat_col <- grazing_data$latitude
lon_col <- grazing_data$longitude
# run function to determine geospatial and temporal coverage
coverage <- data_coverage(dates = date_col, lat = lat_col, lon = lon_col)

# Make EML
make_eml(here(),
         dataset.title = "Phytoplankton growth and microzooplankton grazing rates from NES-LTER transect cruises, ongoing since 2017.",
         data.table = paste0(edi_filename, ".csv"),
         data.table.description = "Phytoplankton growth and microzooplankton grazing rates with size-fractionated chlorophyll concentration",
         other.entity = c("chl-grazing-experiment-temp-inc-data.zip"),
         other.entity.description = c("Temperature and light intensity recorded during the incubation experiments"),
         temporal.coverage = c(coverage$startdate, coverage$enddate),
         geographic.description = "NES-LTER Transect",
         geographic.coordinates = c(coverage$North, coverage$East, coverage$South, coverage$West),
         maintenance.description = "ongoing",
         user.id = "NES",
         user.domain = "LTER",
         package.id = pkg_id)

#  other.entity.description = c("Temperature and light intensity recorded during the incubation experiments with one .csv file per tank including dateTime in UTC, temperature (C) in the incubation tank, and light (lux) in the incubation tank, with a time step of 5 min."),

project_insert(pkg_id, filename='parent_project_RAPID.txt')

```

## Check for issues

```{r}

issues()

```

